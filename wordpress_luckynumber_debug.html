<div class="container-luckynumber">
    <h1>ラッキーナンバー占い</h1>
    <p>あなたの名前と誕生日を入力してください</p>
    <input type="text" id="name-luckynumber" placeholder="名前">
    <input type="date" id="birthday-luckynumber">
    <button id="generate-luckynumber">占う</button>
    <div id="result-luckynumber"></div>
    <div id="audio-debug-luckynumber" style="font-size: 0.8rem; color: #666; margin-top: 1rem;"></div>
</div>

<style>
    .container-luckynumber {
        font-family: sans-serif;
        text-align: center;
        background-color: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        margin: 2rem auto;
        max-width: 500px;
    }

    .container-luckynumber input, .container-luckynumber button {
        margin: 0.5rem;
        padding: 0.5rem;
        border-radius: 5px;
        border: 1px solid #ccc;
        width: 80%;
    }

    .container-luckynumber button {
        cursor: pointer;
        background-color: #007bff;
        color: white;
        width: auto;
        padding: 0.5rem 1.5rem;
    }

    #result-luckynumber {
        margin-top: 1rem;
        font-size: 1.2rem;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const nameInput_ln = document.getElementById('name-luckynumber');
    const birthdayInput_ln = document.getElementById('birthday-luckynumber');
    const generateButton_ln = document.getElementById('generate-luckynumber');
    const resultDiv_ln = document.getElementById('result-luckynumber');
    const audioDebugDiv = document.getElementById('audio-debug-luckynumber');

    let audioContext;
    let fanfareAudio;

    function initAudio() {
        try {
            audioDebugDiv.innerHTML = '音声の準備を試みています...';
            // ユーザーの操作を起点にAudioContextを作成するのが最も確実
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            // 音声ファイルを準備
            if (!fanfareAudio) {
                fanfareAudio = new Audio('https://soundbible.com/mp3/Ta_Da-SoundBible.com-1884170640.mp3');
                fanfareAudio.crossOrigin = "anonymous"; // CORSポリシー対策
                fanfareAudio.addEventListener('canplaythrough', () => {
                    audioDebugDiv.innerHTML = '音声の再生準備ができました。';
                });
                fanfareAudio.addEventListener('error', (e) => {
                    audioDebugDiv.innerHTML = '音声ファイルの読み込みに失敗しました。';
                    console.error('Audio Error:', e);
                });
            }
        } catch (e) {
            audioDebugDiv.innerHTML = 'オーディオ機能の初期化に失敗しました: ' + e.message;
            console.error('AudioContext Error:', e);
        }
    }

    if (generateButton_ln) {
        // 最初のユーザー操作（クリック）でオーディオを初期化
        generateButton_ln.addEventListener('click', () => {
            if (!fanfareAudio) {
                initAudio();
            }

            const name = nameInput_ln.value;
            const birthday = birthdayInput_ln.value;

            if (name && birthday) {
                const seed = name + birthday;
                const luckyNumber = Math.floor(Math.random() * 100) + 1;
                const messages = [
                    "今日は最高の1日になるでしょう！",
                    "新しいことに挑戦すると良い結果が待っています。",
                    "思わぬ幸運が舞い込んでくるかも？",
                    "周りの人に優しくすると、良いことがあります。",
                    "目標に向かって一歩踏み出す日。"
                ];
                const message = messages[Math.floor(Math.random() * messages.length)];

                resultDiv_ln.innerHTML = `
                    <p>${name}さんの今日のラッキーナンバーは「${luckyNumber}」です！</p>
                    <p>${message}</p>
                `;

                // 再生を試みる
                if (fanfareAudio && audioContext && audioContext.state === 'running') {
                    const playPromise = fanfareAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            audioDebugDiv.innerHTML = 'ファンファーレを再生しました！';
                        }).catch(error => {
                            audioDebugDiv.innerHTML = '再生がブラウザにブロックされました。ページをクリックしてからもう一度お試しください。';
                            console.error('Playback failed:', error);
                            // ユーザーによるインタラクション後に再開を試みる
                            audioContext.resume().then(() => {
                                audioDebugDiv.innerHTML += ' オーディオを再開しました。';
                            });
                        });
                    }
                } else {
                     audioDebugDiv.innerHTML = '音声が再生できません。オーディオの準備ができていない可能性があります。';
                }

            } else {
                resultDiv_ln.innerHTML = "<p>名前と誕生日を入力してください。</p>";
            }
        }, { once: false }); // 複数回クリックできるようにonceをfalseに
    }
});
</script>
